<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>성경 퀴즈</title>
  <style>
    :root{
      --bg:#0b1020;--card:#121a34;--ink:#e8eeff;--muted:#9fb0ff;--accent:#7aa2ff;--good:#3ad39f;--bad:#ff6b6b;--warn:#ffb84d;
      --br:18px;--gap:14px;--shadow:0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 25% -10%,#1e2a56 0%,#0b1020 50%),var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:960px;margin:24px auto;padding:16px;position:relative}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#6fa3ff, #9f78ff);display:grid;place-items:center;font-weight:800;color:white;box-shadow:var(--shadow)}
    .card{background:var(--card);border-radius:var(--br);box-shadow:var(--shadow);padding:20px}
    .center{display:grid;place-items:center;min-height:60vh}
    .stack{display:flex;flex-direction:column;gap:var(--gap)}
    input[type="text"]{width:100%;padding:14px 16px;border-radius:12px;border:1px solid #233066;background:#0f1731;color:var(--ink);outline:none}
    button{border:0;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg,#6fa3ff,#9f78ff);color:white;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #2e3a70}
    .muted{color:var(--muted);font-size:.95rem}
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .grow{flex:1}
    .score{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{padding:6px 10px;border-radius:999px;background:#0f1731;border:1px solid #273571}
    .progress{width:100%;height:10px;background:#0f1731;border-radius:999px;overflow:hidden;border:1px solid #26336b}
    .progress>div{height:100%;background:linear-gradient(90deg,#ffb84d,#ff6b6b);width:100%}
    .verse{font-size:1.25rem;line-height:1.9}
    .verse .blank{display:inline-block;min-width:8ch;padding:.15rem .35rem;border-bottom:2px dashed #5a73d6;border-radius:6px;background:rgba(122,162,255,.06)}
    .result{padding:12px 14px;border-radius:12px;background:#0f1731;border:1px solid #243267}
    .result.good{border-color:#24674d;background:#0f1d19}
    .result.bad{border-color:#673024;background:#1d1010}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #243267;text-align:left}
    #adminBtn{position:fixed;bottom:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;z-index:5;}
    .card, button{position:relative;z-index:1;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">BQ</div>
        <div>
          <div style="font-weight:800">성경 퀴즈</div>
          <div class="muted">빈칸 채우기 · 20초 타이머 · 정답 +30점</div>
        </div>
      </div>
      <div class="row score" id="scoreBoard" style="display:none">
        <div class="badge"><span id="playerBadge">게스트</span></div>
        <div class="badge">점수: <b id="score">0</b> / 1000</div>
        <div class="badge warn">남은시간: <b id="time">20</b>s</div>
        <div class="badge">문항: <b id="qIndex">0</b></div>
        <div class="badge">기회: <b id="lives">10</b></div>
      </div>
    </header>

    <!-- 시작 화면 -->
    <section id="start" class="card center">
      <div class="stack" style="max-width:520px">
        <h1>시작하기</h1>
        <input id="nameInput" type="text" placeholder="이름 (예: 홍길동)" />
        <div class="row">
          <button id="startBtn" type="button" class="grow">시작하기</button>
          <button id="rankBtn" type="button" class="ghost">랭킹 보기</button>
          <button id="howBtn" type="button" class="ghost">규칙 보기</button>
        </div>
      </div>
    </section>

    <!-- 퀴즈 화면 -->
    <section id="quiz" class="card" style="display:none">
      <div class="stack">
        <div class="progress"><div id="bar"></div></div>
        <div class="muted" id="ref"></div>
        <div class="verse" id="verse"></div>
        <div class="row wrap">
          <input id="answer" class="grow" type="text" placeholder="빈칸에 들어갈 단어" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" inputmode="text" />
          <button id="submitBtn" type="button">제출</button>
          <button id="passBtn" type="button" class="ghost">패스</button>
        </div>
        <div id="feedback" class="result" style="display:none"></div>
      </div>
    </section>

    <!-- 랭킹 화면 -->
    <section id="leaderboard" class="card" style="display:none">
      <div class="stack">
        <h2>랭킹</h2>
        <div class="row">
          <button id="backStart" type="button" class="ghost">시작 화면</button>
        </div>
        <table>
          <thead>
            <tr><th>순위</th><th>이름</th><th>점수</th><th>완료 시간</th></tr>
          </thead>
          <tbody id="lbBody"></tbody>
        </table>
      </div>
    </section>

    <!-- 운영자 모드 버튼 (구석 펭귄) -->
    <button id="adminBtn" type="button" title="운영자">🐧</button>
  </div>

  <!-- Firebase SDK: 먼저 로드 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
  apiKey: "AIzaSyAnit284Kj3Rv3hXphywKMW-S1jg7TcV_8",
  authDomain: "biblestory-d636c.firebaseapp.com",
  projectId: "biblestory-d636c",
  storageBucket: "biblestory-d636c.appspot.com",
  messagingSenderId: "823812059117",
  appId: "1:823812059117:web:777a2266b354945780c1e4",
  measurementId: "G-5Z4KX2XPP8"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const recordsCol = db.collection('records');

    let QUESTIONS = [
   {book:"출애굽기",ref:"20:12",before:"네 부모를",blank:"공경하라",after:"",answers:["공경하라","공경"]},
  {book:"에베소서",ref:"6:1",before:"자녀들아 너희",blank:"부모에게 순종하라",after:"",answers:["부모에게 순종하라","부모"]},
  {book:"시편",ref:"119:105",before:"주의 말씀은 내 발에",blank:"등이요",after:" 내 길에 빛이니이다",answers:["등이요","등"]},
  {book:"마가복음",ref:"10:14",before:"어린아이들이 내게 오는 것을",blank:"용납하라",after:"",answers:["용납하라","허락하라"]},
  {book:"요한일서",ref:"4:19",before:"우리가 사랑함은 그가 먼저 우리를",blank:"사랑하셨음이라",after:"",answers:["사랑하셨음이라","사랑하셨다"]},
  {book:"빌립보서",ref:"4:4",before:"주 안에서 항상",blank:"기뻐하라",after:"",answers:["기뻐하라","기뻐"]},
  {book:"잠언",ref:"3:5",before:"너는 마음을 다하여 여호와를",blank:"의뢰하고",after:"",answers:["의뢰하고","신뢰하고"]},
  {book:"잠언",ref:"22:6",before:"마땅히 행할 길을",blank:"아이에게 가르치라",after:"",answers:["아이에게 가르치라","아이"]},
  {book:"시편",ref:"150:6",before:"호흡이 있는 자마다",blank:"여호와를 찬양할지어다",after:"",answers:["여호와를 찬양할지어다","찬양할지어다"]},
  {book:"요한복음",ref:"14:6",before:"예수께서 이르시되 내가 곧 길이요",blank:"진리요 생명이니",after:"",answers:["진리요 생명이니","진리요 생명"]},
  {book:"창세기",ref:"1:1",before:"태초에 하나님이 천지를",blank:"창조하시니라",after:"",answers:["창조하시니라","창조"]},
  {book:"시편",ref:"121:2",before:"나의 도움이 천지를 지으신",blank:"여호와에게서로다",after:"",answers:["여호와에게서로다","여호와"]},
  {book:"마태복음",ref:"7:7",before:"구하라 그러면 너희에게",blank:"주실 것이요",after:"",answers:["주실 것이요","주신다"]},
  {book:"데살로니가전서",ref:"5:17",before:"쉬지 말고",blank:"기도하라",after:"",answers:["기도하라","기도"]},
  {book:"데살로니가전서",ref:"5:18",before:"범사에",blank:"감사하라",after:"",answers:["감사하라","감사"]},
  {book:"요한계시록",ref:"22:20",before:"주 예수여",blank:"오시옵소서",after:"",answers:["오시옵소서","오시옵소서 아멘"]}
];
QUESTIONS.push(
  // --- 1~20 ---
  {book:"창세기",ref:"1:1",before:"태초에",blank:"하나님",after:"이 천지를 창조하시니라",answers:["하나님"]},
  {book:"시편",ref:"23:1",before:"여호와는 나의",blank:"목자",after:"시니 내가 부족함이 없으리로다",answers:["목자"]},
  {book:"요한복음",ref:"14:6",before:"예수께서 이르시되 내가 곧 길이요 진리요",blank:"생명",after:"이니",answers:["생명"]},
  {book:"마태복음",ref:"5:9",before:"화평하게 하는 자는 하나님의",blank:"아들",after:"이라 일컬음을 받을 것이요",answers:["아들"]},
  {book:"잠언",ref:"1:7",before:"여호와를 경외하는 것이",blank:"지식",after:"의 근본이거늘",answers:["지식"]},
  {book:"이사야",ref:"9:6",before:"이는 한 아기가 우리에게 났고 한",blank:"아들",after:"을 우리에게 주신 바 되었는데",answers:["아들"]},
  {book:"요한일서",ref:"4:8",before:"사랑하지 아니하는 자는",blank:"하나님",after:"을 알지 못하나니",answers:["하나님"]},
  {book:"마태복음",ref:"6:11",before:"오늘 우리에게 일용할",blank:"양식",after:"을 주옵시고",answers:["양식"]},
  {book:"출애굽기",ref:"20:16",before:"너는 네 이웃에 대하여",blank:"거짓",after:"증거하지 말라",answers:["거짓"]},
  {book:"마태복음",ref:"22:39",before:"네",blank:"이웃",after:"을 네 자신과 같이 사랑하라 하셨으니",answers:["이웃"]},
  {book:"요한복음",ref:"6:35",before:"예수께서 이르시되 나는 생명의",blank:"떡",after:"이니",answers:["떡"]},
  {book:"요한계시록",ref:"22:13",before:"나는 알파와",blank:"오메가",after:"요 처음과 마지막이요 시작과 끝이라",answers:["오메가"]},
  {book:"시편",ref:"119:105",before:"주의 말씀은 내 발에",blank:"등",after:"이요 내 길에 빛이니이다",answers:["등"]},
  {book:"요한복음",ref:"11:25",before:"예수께서 이르시되 나는 부활이요",blank:"생명",after:"이니",answers:["생명"]},
  {book:"갈라디아서",ref:"5:22",before:"오직 성령의",blank:"열매",after:"는 사랑과 희락과 화평이요",answers:["열매"]},
  {book:"마태복음",ref:"7:7",before:"구하라 그리하면 너희에게",blank:"주실",after:"것이요",answers:["주실","준다"]},
  {book:"고린도전서",ref:"13:13",before:"그런즉 믿음 소망",blank:"사랑",after:"이 항상 있을 것인데",answers:["사랑"]},
  {book:"빌립보서",ref:"4:4",before:"주 안에서 항상",blank:"기뻐",after:"하라",answers:["기뻐","기뻐하라"]},

  // --- 21~40 (새로 추가, 중복 참고 절 제거) ---
  {book:"요한복음",ref:"3:16",before:"하나님이 세상을 이처럼 사랑하사",blank:"독생자",after:"를 주셨으니",answers:["독생자"]},
  {book:"마태복음",ref:"5:14",before:"너희는 세상의",blank:"빛",after:"이라",answers:["빛"]},
  {book:"마태복음",ref:"6:33",before:"그런즉 너희는 먼저 그의 나라와 그의",blank:"의",after:"를 구하라",answers:["의"]},
  {book:"출애굽기",ref:"20:12",before:"네",blank:"부모",after:"를 공경하라",answers:["부모"]},
  {book:"에베소서",ref:"6:1",before:"자녀들아 너희",blank:"부모",after:"에게 순종하라",answers:["부모"]},
  {book:"마가복음",ref:"10:14",before:"어린",blank:"아이",after:"들이 내게 오는 것을 용납하라",answers:["아이","어린이"]},
  {book:"요한일서",ref:"4:19",before:"우리가",blank:"사랑",after:"함은 그가 먼저 우리를 사랑하셨음이라",answers:["사랑"]},
  {book:"잠언",ref:"3:5",before:"너는 마음을 다하여 여호와를",blank:"의뢰",after:"하고",answers:["의뢰","신뢰"]},
  {book:"잠언",ref:"22:6",before:"마땅히 행할 길을",blank:"아이",after:"에게 가르치라",answers:["아이"]},
  {book:"시편",ref:"150:6",before:"호흡이 있는 자마다 여호와를",blank:"찬양",after:"할지어다",answers:["찬양"]},
  {book:"시편",ref:"121:2",before:"나의 도움이 천지를 지으신",blank:"여호와",after:"에게서로다",answers:["여호와"]},
  {book:"데살로니가전서",ref:"5:17",before:"쉬지 말고",blank:"기도",after:"하라",answers:["기도"]},
  {book:"데살로니가전서",ref:"5:18",before:"범사에",blank:"감사",after:"하라",answers:["감사"]},
  {book:"요한계시록",ref:"22:20",before:"주 예수여",blank:"오시옵소서",after:"",answers:["오시옵소서"]},
  {book:"요한복음",ref:"8:12",before:"예수께서 이르시되 나는 세상의",blank:"빛",after:"이니",answers:["빛"]},
  {book:"사도행전",ref:"16:31",before:"주 예수를",blank:"믿으라",after:" 그리하면 너와 네 집이 구원을 받으리라",answers:["믿으라","믿어라"]},
  {book:"누가복음",ref:"6:31",before:"남에게 대접을 받고자 하는 대로 너희도",blank:"대접",after:"하라",answers:["대접"]},
  {book:"누가복음",ref:"19:10",before:"인자가 온 것은 잃어버린 자를 찾아",blank:"구원",after:"하려 함이니라",answers:["구원"]},
  {book:"고린도전서",ref:"10:31",before:"무엇을 하든지 다 하나님의",blank:"영광",after:"을 위하여 하라",answers:["영광"]},
  {book:"빌립보서",ref:"4:6",before:"아무 것도",blank:"염려",after:"하지 말고",answers:["염려"]}
);


    // ===== 게임 설정 상수 =====
    const TARGET=1000, POINT=50, LIMIT=20, MAX_LIVES=10;

    // ===== 상태 변수 =====
    let playerName='게스트',score=0,idx=0,left=LIMIT,order=[],timer=null,currentQ=null,lives=MAX_LIVES,locked=false;

    // ===== 엘리먼트 캐시 =====
    const el={
      start:document.getElementById('start'),quiz:document.getElementById('quiz'),leaderboard:document.getElementById('leaderboard'),
      nameInput:document.getElementById('nameInput'),playerBadge:document.getElementById('playerBadge'),score:document.getElementById('score'),
      time:document.getElementById('time'),qIndex:document.getElementById('qIndex'),bar:document.getElementById('bar'),
      verse:document.getElementById('verse'),ref:document.getElementById('ref'),answer:document.getElementById('answer'),
      feedback:document.getElementById('feedback'),lbBody:document.getElementById('lbBody'),lives:document.getElementById('lives'),
      scoreBoard:document.getElementById('scoreBoard')
    };

    // ===== 유틸 =====
    function shuffle(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]];}}
    function norm(s){s=(s||'').toString().toLowerCase();s=s.split(' ').join('');const rm=['[',']','(',')','{','}','\'','.',',',':',';','!','?','·','…','—','–','-','"'];for(let i=0;i<rm.length;i++){s=s.split(rm[i]).join('');}return s;}

    // ===== 화면 전환 =====
    function showStart(){clearInterval(timer);el.start.style.display='grid';el.quiz.style.display='none';el.leaderboard.style.display='none';el.scoreBoard.style.display='none';el.lives.textContent=MAX_LIVES;}
    function showQuiz(){el.start.style.display='none';el.quiz.style.display='block';el.leaderboard.style.display='none';el.scoreBoard.style.display='flex';}
    async function showLeaderboard(){clearInterval(timer);el.start.style.display='none';el.quiz.style.display='none';el.leaderboard.style.display='block';el.scoreBoard.style.display='none';await renderLeaderboard();}

    // ===== 게임 로직 =====
    function startGame(){
      playerName=el.nameInput.value||'게스트';el.playerBadge.textContent=playerName;
      score=0;idx=0;lives=MAX_LIVES;el.lives.textContent=lives;el.score.textContent=score;el.qIndex.textContent=0;
      order=[...Array(QUESTIONS.length).keys()];shuffle(order);showQuiz();nextQuestion();
    }

    function nextQuestion(){
      if(lives<=0){endGame(false);return;}
      if(score>=TARGET){endGame(true);return;}
      if(order.length===0){order=[...Array(QUESTIONS.length).keys()];shuffle(order);} // 무한 랜덤 로테이션
      currentQ=QUESTIONS[order.shift()];idx++;
      el.qIndex.textContent=idx;el.ref.textContent=`${currentQ.book} ${currentQ.ref}`;
      el.verse.innerHTML=`${currentQ.before} <span class="blank">_____</span> ${currentQ.after}`;
      resetAnswerInput();locked=false;setTimeout(()=>{try{el.answer.focus();}catch(e){}},0);runTimer();
    }

    function runTimer(){left=LIMIT;el.time.textContent=left;el.bar.style.width='100%';clearInterval(timer);timer=setInterval(()=>{left--;el.time.textContent=left;el.bar.style.width=(left/LIMIT*100)+'%';if(left<0){clearInterval(timer);loseLife(`⏰ 시간초과! 정답: ${currentQ.blank}`);}},1000);}

    function isCorrectInput(){if(!currentQ)return false;const ans=norm(el.answer.value);const accepts=(currentQ.answers&&currentQ.answers.length?currentQ.answers:[currentQ.blank]).map(norm);return accepts.includes(ans);}    

    function submitAnswer(){if(locked)return;locked=true;const ans=norm(el.answer.value.trim());const accepts=(currentQ.answers&&currentQ.answers.length?currentQ.answers:[currentQ.blank]).map(norm);if(accepts.includes(ans)){score+=POINT;el.score.textContent=score;feedback(true,'정답!');setTimeout(nextQuestion,650);}else{loseLife('오답! 정답: '+currentQ.blank);}}

    function loseLife(msg){locked=true;lives--;el.lives.textContent=lives;feedback(false,msg);if(lives<=0){endGame(false);}else{setTimeout(nextQuestion,800);}}

    function feedback(ok,msg){el.feedback.style.display='block';el.feedback.textContent=msg;el.feedback.className='result '+(ok?'good':'bad');}

    // 입력칸을 항상 새로 생성하여 이전 값 잔존 제거
    function resetAnswerInput(){const old=document.getElementById('answer');const fresh=old.cloneNode(false);fresh.id='answer';fresh.className=old.className;fresh.type='text';fresh.placeholder=old.placeholder;fresh.autocomplete='off';fresh.autocapitalize='off';fresh.autocorrect='off';fresh.spellcheck=false;fresh.inputMode='text';old.parentNode.replaceChild(fresh,old);el.answer=fresh;el.answer.value='';attachAnswerListeners();}

    function attachAnswerListeners(){el.answer.addEventListener('keydown',e=>{if(e.key==='Enter'){submitAnswer();}});el.answer.addEventListener('input',()=>{if(!locked&&isCorrectInput()){submitAnswer();}});}    

    // ===== 랭킹 저장/조회 (Firebase) =====
    async function endGame(success=true){
      if(success && lives>0){
        const now=new Date();
        const finished= now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,'0')+"-"+String(now.getDate()).padStart(2,'0')+" "+now.toLocaleTimeString();
        try{await recordsCol.add({name:playerName||'게스트',score:score,time:finished,createdAt:firebase.firestore.FieldValue.serverTimestamp()});}
        catch(e){console.error('saveRecord failed:',e);alert('기록 저장 중 오류가 발생했어요 😭');}
      }
      showLeaderboard();
    }

    async function renderLeaderboard(){
      try{
        const snap=await recordsCol.orderBy('score','desc').orderBy('createdAt','asc').limit(100).get();
        const rows=[];let rank=1;snap.forEach(doc=>{const r=doc.data();rows.push(`<tr><td>${rank++}</td><td>${(r.name||'')}</td><td>${(r.score||0)}</td><td>${(r.time||'')}</td></tr>`);});
        el.lbBody.innerHTML=rows.join('')||`<tr><td colspan="4">아직 기록이 없습니다.</td></tr>`;
      }catch(e){console.error(e);el.lbBody.innerHTML=`<tr><td colspan="4">랭킹을 불러오지 못했어요.</td></tr>`;}
    }

    // ===== 이벤트 바인딩 =====
    document.getElementById('startBtn').onclick=startGame;
    document.getElementById('submitBtn').onclick=submitAnswer;
    document.getElementById('passBtn').onclick=()=>{loseLife('패스! 정답: '+currentQ.blank)};
    document.getElementById('rankBtn').onclick=showLeaderboard;
    document.getElementById('backStart').onclick=showStart;

    // 운영자: Firestore 랭킹 초기화
    document.getElementById('adminBtn').onclick=async()=>{
      const pw=prompt('비밀번호 입력');
      if(pw!=='eckc3004'){alert('비밀번호 오류');return;}
      if(!confirm('정말 랭킹을 초기화하시겠습니까? (되돌릴 수 없음)')) return;
      try{const snap=await recordsCol.get();const jobs=[];snap.forEach(d=>jobs.push(d.ref.delete()));await Promise.all(jobs);alert('랭킹이 초기화되었습니다.');renderLeaderboard();}
      catch(e){console.error(e);alert('초기화 실패. 콘솔을 확인해 주세요.');}
    };

    // 초기화
    attachAnswerListeners();
    showStart();
  </script>
</body>
</html>
